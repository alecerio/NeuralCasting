#ifndef __NCAST_QSIGMOID__
#define __NCAST_QSIGMOID__

#include <stdint.h>
#include "quant.h"
#include "utils.h"

#define NCAST_SIGMOID_LUT_SIZE (256)

static float32_t NCAST_SIGMOID_LUT[NCAST_SIGMOID_LUT_SIZE] = {
    0.002472623156634775, 0.002590979364429335, 0.002714985469005177, 0.0028449096649795017, 
    0.002981032729854898, 0.0031236485998533117, 0.0032730649706716316, 0.003429603924094488, 
    0.003593602581420091, 0.0037654137846738745, 0.003945406806602024, 0.004133968090452447, 
    0.004331502020563992, 0.004538431724795384, 0.004755199909833049, 0.004982269730421261, 
    0.005220125693558399, 0.005469274598698994, 0.00573024651499208, 0.006003595796571491, 
    0.006289902136892484, 0.006589771663080564, 0.00690383807122188, 0.00723276380347905, 
    0.007577241267860813, 0.007937994101407322, 0.00831577847747413, 0.00871138445770551, 
    0.009125637389180522, 0.009559399347091532, 0.01001357062317314, 0.01048909125993802, 
    0.010986942630593181, 0.011508149064303405, 0.012053779516236448, 0.01262494928156441, 
    0.013222821752305151, 0.013848610215564577, 0.014503579691381982, 0.015189048807983952, 
    0.015906391711814717, 0.016657040009229063, 0.017442484736205344, 0.018264278351857018, 
    0.019124036750888907, 0.02002344128945525, 0.020964240818127505, 0.021948253714867853, 
    0.02297736991002562, 0.024053552894426178, 0.02517884170060186, 0.02635535284611976, 
    0.02758528222679, 0.02887090694628791, 0.03021458706739398, 0.03161876726864549, 
    0.03308597838870414, 0.03461883883917584, 0.036220055864974746, 0.0378924266296074, 
    0.039638839100970026, 0.041462272711409634, 0.043365798763906775, 0.045352580554306424, 
    0.04742587317756679, 0.04958902298403175, 0.05184546664977984, 0.05419872982318559, 
    0.05665242530797385, 0.059210250741285934, 0.06187598572364272, 0.06465348835622392, 
    0.06754669113962912, 0.07055959618729296, 0.07369626970604846, 0.07696083569602614, 
    0.08035746882220708, 0.08389038641057994, 0.08756383952305867, 0.09138210306717136, 
    0.0953494648991095, 0.09947021388210708, 0.10374862686637973, 0.10818895456207037, 
    0.11279540628289322, 0.11757213354550884, 0.12252321251815919, 0.12765262532179067, 
    0.13296424019782926, 0.1384617905689644, 0.1441488530327406, 0.1500288243424251, 
    0.1561048974454574, 0.16238003666671086, 0.16885695214168317, 0.17553807362342938, 
    0.18242552380635635, 0.18952109132967757, 0.19682620364309852, 0.20434189993684584, 
    0.21206880435710532, 0.22000709974589316, 0.22815650216092537, 0.2365162364457076, 
    0.24508501313237172, 0.2538610069692489, 0.26284183737131667, 0.27202455109402257, 
    0.28140560742914383, 0.29098086621490676, 0.3007455789412415, 0.310694383214554, 
    0.320821300824607, 0.3311197396289915, 0.341582499438317, 0.35220178204788966, 
    0.3629692055196168, 0.3738758227716966, 0.3849121444839335, 0.39606816627404173, 
    0.40733340004593027, 0.4186969093556867, 0.43014734858584286, 0.4416730056646256, 
    0.45326184801538616, 0.4649015713733885, 0.47657965106367606, 0.48828339529583464, 
    0.5, 0.5117166047041654, 0.523420348936324, 0.5350984286266115, 0.5467381519846138, 
    0.5583269943353744, 0.5698526514141571, 0.5813030906443133, 0.5926665999540697, 
    0.6039318337259583, 0.6150878555160665, 0.6261241772283034, 0.6370307944803831, 
    0.6477982179521103, 0.658417500561683, 0.6688802603710086, 0.679178699175393, 
    0.689305616785446, 0.6992544210587585, 0.7090191337850932, 0.7185943925708561, 
    0.7279754489059774, 0.7371581626286834, 0.746138993030751, 0.7549149868676283, 
    0.7634837635542924, 0.7718434978390747, 0.7799929002541067, 0.7879311956428947, 
    0.7956581000631541, 0.8031737963569016, 0.8104789086703224, 0.8175744761936437, 
    0.8244619263765707, 0.8311430478583168, 0.8376199633332891, 0.8438951025545426, 
    0.849971175657575, 0.8558511469672594, 0.8615382094310357, 0.8670357598021706, 
    0.8723473746782093, 0.8774767874818407, 0.8824278664544911, 0.8872045937171068, 
    0.8918110454379297, 0.8962513731336202, 0.9005297861178929, 0.9046505351008904, 
    0.9086178969328287, 0.9124361604769412, 0.91610961358942, 0.9196425311777929, 
    0.9230391643039738, 0.9263037302939515, 0.9294404038127071, 0.9324533088603709, 
    0.9353465116437761, 0.9381240142763573, 0.9407897492587141, 0.9433475746920261, 
    0.9458012701768145, 0.94815453335022, 0.9504109770159683, 0.9525741268224331, 
    0.9546474194456934, 0.9566342012360932, 0.9585377272885904, 0.96036116089903, 
    0.9621075733703927, 0.9637799441350253, 0.9653811611608242, 0.9669140216112958, 
    0.9683812327313545, 0.9697854129326061, 0.9711290930537122, 0.9724147177732099, 
    0.9736446471538801, 0.9748211582993981, 0.9759464471055739, 0.9770226300899744, 
    0.978051746285132, 0.9790357591818724, 0.9799765587105447, 0.9808759632491112, 
    0.9817357216481429, 0.9825575152637948, 0.9833429599907708, 0.9840936082881853, 
    0.984810951192016, 0.985496420308618, 0.9861513897844354, 0.9867771782476948, 
    0.9873750507184357, 0.9879462204837635, 0.9884918509356967, 0.9890130573694068, 
    0.9895109087400621, 0.9899864293768268, 0.9904406006529085, 0.9908743626108194, 
    0.9912886155422945, 0.9916842215225259, 0.9920620058985926, 0.9924227587321393, 
    0.992767236196521, 0.993096161928778, 0.9934102283369194, 0.9937100978631075, 
    0.9939964042034285, 0.994269753485008, 0.9945307254013009, 0.9947798743064417, 
    0.9950177302695786, 0.9952448000901669, 0.9954615682752046, 0.9956684979794361, 
    0.9958660319095476, 0.9960545931933981, 0.9962345862153261, 0.9964063974185798, 
    0.9965703960759055, 0.9967269350293284, 0.9968763514001466, 0.9970189672701452, 
    0.9971550903350206, 0.9972850145309949, 0.9974090206355707
};

#define NCAST_SIGMOID_MIN_X (-6.0f)
#define NCAST_SIGMOID_MAX_X (6.0f)

#define NCAST_ACCESS_SIGMOID_LUT(X, Y) \
if(X < NCAST_SIGMOID_MIN_X) \
    Y = NCAST_SIGMOID_LUT[0]; \
else if(X > NCAST_SIGMOID_MAX_X) \
    Y = NCAST_SIGMOID_LUT[NCAST_SIGMOID_LUT_SIZE-1]; \
else { \
    float32_t x_normalized = (X - NCAST_SIGMOID_MIN_X) / (NCAST_SIGMOID_MAX_X - NCAST_SIGMOID_MIN_X); \
    int32_t ix = (int32_t)(x_normalized * NCAST_SIGMOID_LUT_SIZE); \
    float32_t dx = X - (int32_t) X; \
    float32_t y0 = NCAST_SIGMOID_LUT[ix]; \
    float32_t y1 = NCAST_SIGMOID_LUT[ix+1]; \
    Y = y0 + (y1 - y0) * dx; \
}

#define NCAST_SIGMOID(X, Y, SIZE) \
for(int i=0; i<SIZE; i++) { \
    NCAST_ACCESS_SIGMOID_LUT(X[i], Y[i]); \
}

#define NCAST_QSIGMOID(X, Sx, Zx, Sy, Zy, Y, SIZE) \
{ \
    float32_t Xdq[SIZE], Ydq[SIZE]; \
    NCAST_DQUANT8_FIXED(X, Xdq, SIZE, Sx, Zx) \
    for(int i=0; i<SIZE; i++) { \
        NCAST_ACCESS_SIGMOID_LUT(Xdq[i], Ydq[i]); \
    } \
    NCAST_QUANT8_FIXED(Ydq, Y, SIZE, Sy, Zy) \
}

#endif // __NCAST_QSIGMOID__
